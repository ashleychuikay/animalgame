---
title: "Animal Game Transcripts"
author: "Ashley Leung, Alex Tunkel, and Dan Yurovsky"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: hide
---
```{r, message=FALSE, warning=FALSE, show = F}
library(tidyverse)
library(forcats)
library(knitr)
library(tidytext)
library(readxl)
library(tidyboot)
library(stringr)
library(janitor)
library(here)
library(ggthemes)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)


theme_set(theme_classic(base_size = 16))
```

Read in vocab data

```{r read_data, message=F}
qualtrics_data <- read_csv(here("../raw_data/qualtrics_data.csv")) %>%
  slice(3:nrow(.)) %>%
  clean_names()

qualtrics_ids <- read_csv(here("../raw_data/qualtrics_ids.csv")) %>%
  clean_names()

survey1 <- read_csv(here("../raw_data/survey_link1.csv"))
survey2 <- read_csv(here("../raw_data/survey_link2.csv"))

vocab_data <- bind_rows(survey1, survey2) %>%
  clean_names() %>%
  filter(!is.na(response_id)) %>%
  left_join(qualtrics_data, by = "response_id") %>%
  select(link, q1) %>%
  left_join(qualtrics_ids, by = "link") %>%
  select(q1, response_id, number) %>%
  rename(video_id = response_id, subj = number) %>%
  filter(!is.na(subj))

```

Munge vocab data
```{r munge_vocab}
tidy_vocab <- vocab_data %>%
  unnest_tokens(word, q1) %>% 
  mutate(understands = T) %>%
  select(-video_id) %>%
  complete(subj, word, fill = list(understands = F)) %>%
  left_join(select(vocab_data, -q1), by = "subj")
```
Read in response data
```{r read_response}
child_response <- read_csv(here("../raw_data/animalgame_data.csv")) %>%
  filter(!subj %in% c("xx", "Twst", "Test", "test"))

missing_data <- read_csv(here("../raw_data/animalgame_missing.csv"))

filled_data <- bind_rows(child_response, missing_data)

response_data <- left_join(vocab_data, filled_data, by = "subj") %>%
  mutate(game_trial = trial_type != "practice") %>%
  arrange(subj, game_trial, trial_num) %>%
  group_by(subj) %>%
  mutate(trial_num = 1:n(),
         correct = correct == "Y")


#write_csv(response_data, "wrong_trialnums.csv")

```

Read in transcript data
```{r munge}
transcripts <- list.files(here("../raw_data/coded"), "*.csv", full.names = T)


read_transcript <- function(file) {

  transcript <- read_csv(file) %>%
    mutate(id = str_split(file, "[//.]")[[1]] %>% tail(2) %>% head(1)) %>%
    remove_empty("cols") %>%
    clean_names()
    
    # Pull out either parent or child's data
    pull_data <- function(person) {
      transcript %>%
        select(starts_with(person)) %>%
        select_all(~gsub(paste0(person,"_"), "", .x)) %>%
        select_all(~gsub("utterance_", "", .x)) %>%
        mutate(person = person) %>%
        mutate(id = first(transcript$id))
    
    }
  
  # Tidy up
  bind_rows(pull_data("child"), pull_data("parent")) %>%
    mutate(target = gsub("\\.", "", target) %>% tolower) %>%
    mutate(utterance = str_trim(utterance))
    # mutate(target = case_when(target == "rhinocerous" ~ "rhinoceros", 
    #                           T ~ target)) 
}

tidy_data <- map(transcripts, read_transcript) %>%
  bind_rows()

targets <- tidy_data %>%
  distinct(target) %>%
  filter(!is.na(target), !target %in% c("n/a")) %>%
  pull()

practice_targets <- c("artichoke", "apple") 
```

The unique targets were: `r targets`

```{r word_difficulty}
word_difficulty <- tidy_vocab %>%
  filter(word %in% targets) %>%
  group_by(word) %>%
  tidyboot_mean(understands) %>%
  rename(understands = empirical_stat) %>%
  arrange(desc(understands))

plotting_words <- word_difficulty %>%
  mutate(word = factor(word, levels = unique(word)))

ggplot(plotting_words, aes(x = word, y = understands, ymin = ci_lower, 
                            ymax = ci_upper)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  geom_pointrange()
```

Munge transcript data
```{r make_target_df}
trials <- tidy_data %>%
  group_by(id) %>%
  arrange(id, onset) %>%
  filter(target %in% targets) %>%
  mutate(new_trial = target != lag(target),
         new_trial = if_else(is.na(new_trial), TRUE, new_trial),
         trial = cumsum(new_trial)) %>%
  select(-new_trial)


# Selections per target--should be 2 for each target for each id
selects <- trials %>%
  filter(selection == "selects") %>%
  group_by(id, target) %>%
  summarise(n = n()) %>%
  filter(n != 2)

trial_targets <- trials %>%
  distinct(id, trial, target) %>%
  rename(trial_target = target)

# Trials per target, should be 2 for each id
trial_targets %>%
  group_by(id, trial_target) %>%
  summarise(n = n()) %>% 
  filter(n != 2)

parent_data <- tidy_data %>%
#  filter(id != "9261") %>%
  filter(person == "parent") %>%
  left_join(trials) %>%
  group_by(id) %>%
  fill(trial) %>%
  filter(!is.na(trial)) %>%
  group_by(id, trial) %>%
  mutate(selection = max(0, which(str_detect(selection, "selects")),
                             na.rm = T)) %>%
  mutate(phase = case_when(row_number() < selection ~ "pre",
                           row_number() == selection ~ "during",
                           T ~ "post") %>%
           factor(levels = c("pre", "during", "post"))) %>%
  left_join(trial_targets) %>%
 # filter(!is.na(target), !target %in% c("<target>", "n/a")) %>%
  group_by(id, trial_target) %>%
  mutate(appearance = factor(trial >= mean(trial))) %>%
  ungroup() %>%
  mutate(appearance = factor(appearance, labels = c("first", "second")),
         id = as.character(id))


target_data_gaps <- parent_data %>%
  mutate(length = str_count(utterance, " ") + 1) %>%
  left_join(word_difficulty, by = c("target" = "word")) %>%
  rename(difficulty = understands) %>%
  left_join(tidy_vocab, by = c("id" = "video_id", "trial_target" = "word")) %>%
 # filter(phase != "during") %>%
  group_by(phase, difficulty, understands, appearance, trial_target, id)

ids <- target_data_gaps %>%
  ungroup() %>%
  distinct(id, subj) %>%
  filter(!is.na(subj))

target_data <- target_data_gaps %>%
  select(-subj) %>%
  left_join(ids) %>%
  left_join(response_data, by = c("subj", "trial_target" = "target", "trial" = "trial_num")) %>%
  filter(trial_type != "practice")
```

```{r accuracy}

cor.test(target_data$difficulty, as.numeric(target_data$correct), 
         use = "complete", method = "kendall")

```

```{r plot_lengths_aggregate}
target_data %>%
  filter(phase != "during") %>%
  summarise(length = sum(length)) %>%
  ggplot(aes(x = difficulty, y = log(length), color = phase)) + 
  facet_wrap(~ appearance) +
  geom_point() +
  geom_smooth(method = "glm", se = F) +
  scale_color_ptol()
```

```{r plot_lengths_personal}
mean_data <- target_data %>%
  filter(phase != "during") %>%
  summarise(length = sum(length)) %>%
  group_by(phase, appearance, understands, id, trial_target) %>%
  summarise(length = sum(length, na.rm = T)) %>%
  summarise(length = mean(log(length+1), na.rm = T)) %>%
  tidyboot_mean(length)

ggplot(filter(mean_data, !is.na(understands)),
       aes(x = understands, y = empirical_stat, 
           ymin = ci_lower, ymax = ci_upper, color = phase)) + 
  facet_wrap(~ appearance) +
  geom_pointrange(position = position_dodge(.5)) +
  scale_color_ptol()
```

```{r first_utterance}
mean_data <- target_data %>%
  filter(phase != "during") %>%
  group_by(phase, appearance, understands, id, trial_target) %>%
  arrange(id, appearance, phase, trial_target, onset) %>%
  summarise(length = first(length)) %>%
  summarise(length = mean(log(length+1), na.rm = T)) %>%
  tidyboot_mean(length)

ggplot(filter(mean_data, !is.na(understands)),
       aes(x = understands, y = empirical_stat, 
           ymin = ci_lower, ymax = ci_upper, color = phase)) + 
  facet_wrap(~ appearance) +
  geom_pointrange(position = position_dodge(.5)) +
  scale_color_ptol()

```


```{r lag_analysis}
#pdf("lag_data.pdf", width = 6, height = 4)
target_data %>%
  ungroup() %>%
  mutate(understands = factor(understands, labels = c("unknown", "known"))) %>%
  filter(!id %in% c("10397", "8787")) %>%
#  mutate(phase = factor(as.character(phase), levels = c("pre", "post"))) %>%
  group_by(id, phase, understands, trial_target, appearance, correct) %>%
  summarise(length = sum(length)) %>%
  ungroup() %>%
  complete(nesting(id, trial_target, understands,  correct,  appearance), phase,
           fill = list(length = 0)) %>%
  arrange(id, phase, understands, trial_target,appearance, correct) %>%
  group_by(id, phase, understands, trial_target) %>%
  mutate(lag_correct = lag(correct)) %>%
  filter(appearance == "second", phase != "during") %>%
  group_by(phase, understands, lag_correct, id, trial_target) %>%
  summarise(length = sum(length, na.rm = T)) %>%
  summarise(length = mean(log(length+1), na.rm = T)) %>%
  filter(!is.na(understands)) %>%
  tidyboot_mean(length) %>%
  ggplot(aes(x = lag_correct, y = empirical_stat, 
           ymin = ci_lower, ymax = ci_upper, color = phase)) + 
  facet_wrap(~ understands) +
  geom_pointrange(position = position_dodge(.5)) +
  scale_color_ptol()
#dev.off()
```

```{r lag_analysis}
#pdf("lag_len.pdf", width = 6, height = 4)
target_data %>%
  filter(!id %in% c("10397", "8787")) %>%
#  mutate(phase = factor(as.character(phase), levels = c("pre", "post"))) %>%
  group_by(id, phase, understands, trial_target, appearance, correct) %>%
  summarise(length = sum(length, na.rm = T)) %>%
  ungroup() %>%
  complete(nesting(id, trial_target, understands,  correct,  appearance), phase,
           fill = list(length = 0)) %>%
  filter(phase != "during") %>%
  arrange(id, phase, understands, trial_target, appearance, correct) %>%
  mutate(lag_correct = lag(correct), lag_length = lag(length)) %>%
  filter(appearance == "second") %>%
  group_by(phase, understands, lag_correct, id, trial_target) %>%
  summarise(length = mean(log(length+1), na.rm = T),
            lag_length = mean(log(lag_length+1), na.rm = T)) %>%
  mutate(diff = length - lag_length) %>%
  filter(!is.na(understands)) %>%
  group_by(phase, understands, lag_correct) %>%
  tidyboot_mean(diff) %>%
  ggplot(aes(x = lag_correct, y = empirical_stat, 
           ymin = ci_lower, ymax = ci_upper, color = phase)) + 
  facet_wrap(~ understands) +
  geom_pointrange(position = position_dodge(.5))
#dev.off()
```

```{r show_lobster}
target_data %>%
  filter(trial_target == "lobster") %>%
  kable()
```
