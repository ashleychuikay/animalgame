---
title: "Animal Game Transcripts"
author: "Ashley Leung, Alex Tunkel, and Dan Yurovsky"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: hide
---
```{r, message=FALSE, warning=FALSE, show = F}
library(tidyverse)
library(forcats)
library(knitr)
library(tidytext)
library(readxl)
library(tidyboot)
library(stringr)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = TRUE, tidy = FALSE)


theme_set(theme_classic(base_size = 16))
```

Read in vocab data

```{r read_data, message=F}
survey1 <- read_csv("../raw_data/Vocabulary_Measure-Distribution_History.csv")
survey2 <- read_csv("../raw_data/Vocabulary_Measure-Distribution_History (1).csv")

vocab_measure1 <- rbind(survey1,survey2) %>%
  filter(!is.na(`Response ID`)) %>%
  select(`Response ID`, Link)

vocab_measure2 <- read_csv("../raw_data/Vocabulary Measure_September 12, 2018_12.36.csv") %>%
  slice(3:nrow(.))

vocab_measure <- vocab_measure1 %>%
  left_join(vocab_measure2, by = c(`Response ID` = "ResponseId")) %>%
  select(`Response ID`, Link, Q1)


vocab_data <- left_join(vocab_measure,
                        read_xlsx("../raw_data/qualtrics cdi links.csv.xlsx"),
                        by = "Link") %>%
  select(`Response ID.y`, Q1, '#') %>%
  rename(ResponseId = `Response ID.y`) %>%
  mutate(ResponseId = as.integer(ResponseId))
```

Munge vocab data
```{r munge_vocab}
tidy_vocab <- vocab_data %>%
  unnest_tokens(word, Q1) %>% 
  mutate(understands = T) %>%
  complete(ResponseId, word, fill = list(understands = F)) %>%
  mutate(ResponseId = as.character(ResponseId))
```
Read in response data
```{r read_response}
child_response <- read_csv("../raw_data/animalgame_results.csv")

response_data <- left_join(vocab_data,
                           child_response,
                           by = c(`#` = "SubID"))
```

Read in transcript data
```{r munge}
transcripts <- list.files("../raw_data/coded", "*.csv", full.names = T)


read_transcript <- function(file) {

  transcript <- read_csv(file) %>%
    mutate(id = str_split(file, "[//.]")[[1]][6])
    
    # Pull out either parent or child's data
    pull_data <- function(person) {
      transcript %>%
        select(starts_with(person)) %>%
        select_all(~gsub(person, "", .x)) %>%
        select_all(~gsub("Utterance\\.", "", .x)) %>%
        mutate(person = person) %>%
        mutate(id = first(transcript$id))
    
    }
  
  # Tidy up
  bind_rows(pull_data("Child"), pull_data("Parent")) %>%
    mutate(target = gsub("\\.", "", target) %>% tolower) %>%
    mutate(utterance = str_trim(utterance)) %>%
    mutate(target = case_when(target == "rhinocerous" ~ "rhinoceros", 
                              target == "ducj" ~ "duck",
                              target == "co" ~ "cow",
                              T ~ target)) 
}

tidy_data <- map(transcripts, read_transcript) %>%
  bind_rows()

targets <- tidy_data %>%
  distinct(target) %>%
  filter(!is.na(target), !target %in% c("n/a", "<target>")) %>%
  pull()

practice_targets <- c("artichoke", "apple") 
```

The unique targets were: `r targets`

```{r word_difficulty}
word_difficulty <- tidy_vocab %>%
  filter(word %in% targets) %>%
  group_by(word) %>%
  tidyboot_mean(understands) %>%
  rename(understands = empirical_stat) %>%
  arrange(desc(understands))

plotting_words <- word_difficulty %>%
  mutate(word = factor(word, levels = unique(word)))

ggplot(plotting_words, aes(x = word, y = understands, ymin = ci_lower, 
                            ymax = ci_upper)) + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  geom_pointrange()
```

Munge transcript data
```{r make_target_df}
trials <- tidy_data %>%
  group_by(id) %>%
  arrange(onset) %>%
  filter(target %in% targets) %>%
  mutate(new_trial = target != lag(target),
         new_trial = if_else(is.na(new_trial), TRUE, new_trial),
         trial = cumsum(new_trial)) %>%
  select(-new_trial)


trial_targets <- trials %>%
  distinct(id, trial, target) %>%
  rename(trial_target = target)

parent_data <- tidy_data %>%
  filter(id != "9261") %>%
  filter(person == "Parent") %>%
  left_join(trials) %>%
  group_by(id) %>%
  fill(trial) %>%
  filter(!is.na(trial)) %>%
  group_by(id, trial) %>%
  mutate(selection = max(0, which(str_detect(selection, "selects")),
                             na.rm = T)) %>%
  mutate(phase = case_when(row_number() < selection ~ "pre",
                           row_number() == selection ~ "during",
                           T ~ "post") %>%
           factor(levels = c("pre", "during", "post"))) %>%
  left_join(trial_targets) %>%
 # filter(!is.na(target), !target %in% c("<target>", "n/a")) %>%
  group_by(id, trial_target) %>%
  mutate(appearance = factor(trial >= mean(trial))) %>%
  ungroup() %>%
  mutate(appearance = factor(appearance, labels = c("first", "second")),
         id = as.character(id))


target_data <- parent_data %>%
  mutate(length = str_count(utterance, " ") + 1) %>%
  left_join(word_difficulty, by = c("target" = "word")) %>%
  rename(difficulty = understands) %>%
  left_join(tidy_vocab, by = c("id" = "ResponseId", "trial_target" = "word")) %>%
  filter(phase != "during") %>%
  group_by(phase, difficulty, understands, appearance, trial_target, id) %>%
  summarise(length = sum(length))
```

```{r plot_lengths_aggregate}
ggplot(target_data, aes(x = difficulty, y = log(length), color = phase)) + 
  facet_wrap(~ appearance) +
  geom_point() +
  geom_smooth(method = "loess", se = F)
```

```{r plot_lengths_personal}
mean_data <- target_data %>%
  group_by(phase, appearance, understands, id, trial_target) %>%
  summarise(length = sum(length, na.rm = T)) %>%
  summarise(length = mean(log(length+1)), na.rm = T) %>%
  tidyboot_mean(length)

ggplot(filter(mean_data, !is.na(understands)),
       aes(x = understands, y = empirical_stat, 
           ymin = ci_lower, ymax = ci_upper, color = phase)) + 
  facet_wrap(~ appearance) +
  geom_pointrange(position = position_dodge(.5))
```


```{r show_lobster}
target_data %>%
  filter(trial_target == "lobster") %>%
  kable()
```